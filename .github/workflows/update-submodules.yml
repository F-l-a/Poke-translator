name: Update Submodules

on:
  # Permetti esecuzione manuale
  workflow_dispatch:
  
  # Controllo settimanale come fallback
  schedule:
    - cron: '0 6 * * 1'  # Ogni lunedÃ¬ alle 06:00 UTC

permissions:
  contents: write
  actions: write # Necessario per triggerare altri workflow tramite gh CLI

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0 # Fondamentale per avere la cronologia completa
        token: ${{ secrets.PAT_PUSH || secrets.GITHUB_TOKEN }}
    
    - name: Debug and ensure submodules are initialized
      run: |
        echo "=== Debugging submodule state ==="
        echo "Current working directory:"
        pwd
        
        echo "Contents of current directory:"
        ls -la
        
        echo "Contents of input directory:"
        ls -la input/ || echo "input/ directory not found"
        
        echo "Checking .gitmodules file:"
        cat .gitmodules || echo ".gitmodules not found"
        
        echo "Git submodule status:"
        git submodule status || echo "No submodules found"
        
        echo "=== Reinitializing submodules ==="
        git submodule update --init --recursive --force
        
        echo "After reinitialization - input directory contents:"
        ls -la input/
        
        echo "SupersStrings directory check:"
        if [ -d "input/SupersStrings" ]; then
          echo "âœ… SupersStrings directory exists"
          ls -la input/SupersStrings/
        else
          echo "âŒ SupersStrings directory still missing!"
          echo "Attempting manual clone..."
          mkdir -p input
          git clone https://github.com/superworldsun/SupersStrings input/SupersStrings
        fi
    
    - name: Check for new commits and update submodule
      id: update
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Final check before cd
        if [ ! -d "input/SupersStrings" ]; then
          echo "FATAL: input/SupersStrings directory does not exist after all attempts"
          exit 1
        fi
        
        # Salva l'hash del commit attuale prima dell'aggiornamento
        cd input/SupersStrings
        PREVIOUS_HASH=$(git rev-parse --short HEAD)
        cd ../..
        
        # Aggiorna il sottomodulo all'ultimo commit del branch remoto
        git submodule update --remote input/SupersStrings
        
        # Controlla se il puntatore del sottomodulo Ã¨ cambiato nel repo principale
        if git diff --quiet input/SupersStrings; then
          echo "No changes detected. Submodule is up to date."
          echo "has_updates=false" >> $GITHUB_OUTPUT
        else
          echo "New commits found! Submodule updated."
          echo "has_updates=true" >> $GITHUB_OUTPUT
          
          # Estrai i dati per il commit e il changelog
          cd input/SupersStrings
          NEW_HASH=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=short)
          CHANGELOG=$(git log --oneline --pretty=format:"- %s" $PREVIOUS_HASH..$NEW_HASH)
          cd ../..
          
          echo "previous_hash=$PREVIOUS_HASH" >> $GITHUB_OUTPUT
          echo "new_hash=$NEW_HASH" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          
          # Multiline output per il changelog
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.update.outputs.has_updates == 'true'
      env:
        REPO_TOKEN: ${{ secrets.PAT_PUSH || secrets.GITHUB_TOKEN }}
      run: |
        git add input/SupersStrings
        
        PREVIOUS_HASH="${{ steps.update.outputs.previous_hash }}"
        NEW_HASH="${{ steps.update.outputs.new_hash }}"
        
        git commit -m "Auto-update SupersStrings submodule ($PREVIOUS_HASH â†’ $NEW_HASH)

        Update Date: ${{ steps.update.outputs.commit_date }}
        
        Changes in this update:
        ${{ steps.update.outputs.changelog }}"
        
        BRANCH="${GITHUB_REF##*/}"
        git push "https://x-access-token:${REPO_TOKEN}@github.com/${{ github.repository }}.git" HEAD:"$BRANCH"
    
    - name: Create summary
      if: steps.update.outputs.has_updates == 'true'
      run: |
        PREVIOUS_HASH="${{ steps.update.outputs.previous_hash }}"
        NEW_HASH="${{ steps.update.outputs.new_hash }}"
        
        echo "## SupersStrings Submodule Updated!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**SupersStrings** has been updated from commit **$PREVIOUS_HASH** to **$NEW_HASH**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Commits in This Update:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.update.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: Trigger automatic release
      if: steps.update.outputs.has_updates == 'true'
      env:
        GH_TOKEN: ${{ secrets.PAT_PUSH || secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸš€ Triggering automatic release workflow..."
        gh workflow run auto-release.yml --field is_automatic=true
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY  
        echo "ðŸš€ **Automatic Release Triggered!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The auto-release workflow has been started automatically." >> $GITHUB_STEP_SUMMARY
        echo "Check the [Actions tab](https://github.com/${{ github.repository }}/actions) for progress." >> $GITHUB_STEP_SUMMARY
    
    - name: No updates summary
      if: steps.update.outputs.has_updates == 'false'
      run: |
        echo "## No Updates Available" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "SupersStrings submodule is already up to date with the latest commits!" >> $GITHUB_STEP_SUMMARY
